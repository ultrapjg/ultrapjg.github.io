<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>박병훈 타자영어공부하기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .shake { animation: shake 0.4s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        #custom-words-input::-webkit-scrollbar, #saved-lists-container::-webkit-scrollbar { width: 8px; }
        #custom-words-input::-webkit-scrollbar-track, #saved-lists-container::-webkit-scrollbar-track { background: #f1f5f9; }
        #custom-words-input::-webkit-scrollbar-thumb, #saved-lists-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        #custom-words-input::-webkit-scrollbar-thumb:hover, #saved-lists-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
        #typing-area { display: flex; align-items: center; justify-content: center; padding: 1rem; border: 2px solid #cbd5e1; border-radius: 0.5rem; min-height: 80px; cursor: text; }
        #typing-area .char { font-size: 2.25rem; font-weight: 700; transition: color 0.1s, transform 0.1s; }
        #typing-area .char-placeholder { color: #d1d5db; }
        #typing-area .char-active { color: #9ca3af; border-bottom: 3px solid #6366f1; animation: blink 1s infinite; }
        @keyframes blink { 50% { border-bottom-color: transparent; } }
        #typing-area .char-correct { color: #1f2937; }
        #typing-area .char-incorrect { color: #ef4444; transform: scale(1.1); }
        #db-status-dot { width: 10px; height: 10px; border-radius: 50%; transition: background-color 0.5s; }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl p-4 sm:p-6 bg-white rounded-xl shadow-2xl flex flex-col md:flex-row gap-6">
        
        <!-- 왼쪽 정보 패널 -->
        <div class="w-full md:w-64 bg-slate-50 p-6 rounded-lg flex flex-col gap-6 order-2 md:order-1">
            <div class="flex justify-between items-center border-b pb-3">
                 <h2 class="text-xl font-bold text-slate-700">진행 통계</h2>
                 <div id="db-status" class="flex items-center gap-2 text-sm text-slate-400">
                     <div id="db-status-dot" class="bg-gray-400"></div>
                     <span id="db-status-text">연결중</span>
                 </div>
            </div>
            <div class="space-y-4 text-lg flex-grow">
                <div><p class="text-slate-500">진행시간</p><p><span id="timer" class="font-bold text-indigo-600 text-2xl">0</span> s</p></div>
                <div><p class="text-slate-500">현재타수(타/분)</p><p><span id="wpm" class="font-bold text-indigo-600 text-2xl">0</span></p></div>
                <div><p class="text-slate-500">최고타수(타/분)</p><p><span id="peak-wpm" class="font-bold text-indigo-600 text-2xl">0</span></p></div>
                <div><p class="text-slate-500">정확도(%)</p><p><span id="accuracy" class="font-bold text-indigo-600 text-2xl">100</span> %</p></div>
                <div><p class="text-slate-500">점수</p><p><span id="score" class="font-bold text-indigo-600 text-2xl">0</span></p></div>
            </div>
            <div class="mt-auto pt-4 space-y-2">
                 <div id="user-profile" class="hidden items-center gap-3 p-2 rounded-lg bg-slate-200">
                    <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User photo">
                    <div class="flex-grow truncate">
                        <p id="user-name" class="font-semibold text-sm truncate"></p>
                        <button id="logout-btn" class="text-xs text-red-500 hover:underline">로그아웃</button>
                    </div>
                </div>
                <button id="login-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-indigo-600 text-indigo-600 hover:bg-indigo-50 font-bold py-2 px-4 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/></svg>
                    <span>Google 로그인</span>
                </button>
                <p class="text-xs text-slate-400 text-center">Version 2.2.0</p>
            </div>
        </div>

        <!-- 오른쪽 게임 영역 -->
        <div id="game-container" class="flex-1 flex flex-col relative order-1 md:order-2">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-slate-700">박병훈 타자영어공부하기</h1>
                <button id="settings-btn" class="p-2 text-slate-500 hover:text-indigo-600 transition-colors rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c-1.4-.413-1.4-2.397 0-2.81l.34-.1a1.464 1.464 0 0 1 .872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                </button>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center">
                <div class="w-full flex-grow flex flex-col items-center justify-center bg-slate-50 rounded-lg p-8">
                    <div class="relative flex items-center">
                         <div class="text-center">
                            <div id="word-meaning" class="mb-2 text-xl text-slate-500 h-8"></div>
                            <div id="typing-area" class="font-mono" tabindex="0"></div>
                        </div>
                        <button id="speak-btn" class="ml-4 p-2 text-slate-400 hover:text-indigo-600 transition-colors rounded-full hover:bg-slate-200 self-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707zm-1.414-1.414A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.482 5.482 0 0 1 11.025 8a5.482 5.482 0 0 1-1.61 3.89l.706.706zm-1.414-1.414A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>
                        </button>
                    </div>
                    <div id="upcoming-words" class="mt-6 text-xl text-gray-400 font-mono tracking-wider h-8"></div>
                </div>
            </div>
            <div id="modal-container">
                <div id="start-modal" class="absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center z-20 rounded-xl">
                    <div class="text-center">
                        <h2 class="text-4xl font-bold mb-4 text-slate-800">박병훈 타자영어공부하기</h2>
                        <p class="text-lg mb-8 text-slate-600">아래 버튼을 눌러 게임을 시작하세요.</p>
                        <button id="start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105">게임 시작</button>
                    </div>
                </div>
                <div id="game-over-screen" class="absolute inset-0 bg-white bg-opacity-95 flex-col items-center justify-center z-20 rounded-xl hidden">
                    <h2 class="text-5xl font-bold mb-4 text-red-500">게임 종료</h2>
                    <div class="text-2xl mb-8 space-y-2">
                        <p>최종 점수: <span id="final-score" class="font-bold">0</span>점</p>
                        <p>최고 타수: <span id="final-peak-wpm" class="font-bold">0</span> 타/분</p>
                        <p>평균 정확도: <span id="final-accuracy" class="font-bold">0</span> %</p>
                    </div>
                    <button id="restart-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform hover:scale-105">다시 시작</button>
                </div>
                <div id="settings-modal" class="absolute inset-0 bg-white bg-opacity-95 flex-col items-center justify-center z-20 rounded-xl p-8 hidden">
                     <h2 class="text-3xl font-bold mb-6 text-slate-800">설정</h2>
                    <div class="w-full max-w-2xl space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">시간 설정</h3>
                            <div id="time-limit-options" class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="time" value="0" checked> 무제한</label>
                                <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="time" value="60"> 60초</label>
                                <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="time" value="120"> 120초</label>
                                <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="time" value="180"> 180초</label>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">단어 목록 선택</h3>
                            <div id="category-options" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">나만의 단어장 관리</h3>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="custom-list-name" class="flex-grow p-2 border rounded-md focus:outline-none focus:border-indigo-500" placeholder="단어장 이름">
                                <button id="save-list-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">저장</button>
                            </div>
                            <textarea id="custom-words-input" class="w-full h-24 p-2 border rounded-md focus:outline-none focus:border-indigo-500" placeholder="예시)&#10;apple,사과&#10;banana,바나나"></textarea>
                            
                            <h4 class="text-md font-semibold mt-4 mb-2">저장된 목록</h4>
                            <div id="saved-lists-container" class="w-full h-24 p-2 border rounded-md overflow-y-auto bg-slate-100">
                                <p class="text-slate-400">목록 로딩 중...</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button id="start-game-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">선택한 설정으로 시작</button>
                        <button id="close-settings-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-6 rounded-lg">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDoc, getDocs, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 요소 ---
        const typingArea = document.getElementById('typing-area');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const wpmDisplay = document.getElementById('wpm');
        const peakWpmDisplay = document.getElementById('peak-wpm');
        const accuracyDisplay = document.getElementById('accuracy');
        const upcomingWordsDisplay = document.getElementById('upcoming-words');
        const wordMeaningDisplay = document.getElementById('word-meaning');
        const speakBtn = document.getElementById('speak-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveListBtn = document.getElementById('save-list-btn');
        const startModal = document.getElementById('start-modal');
        const gameOverScreen = document.getElementById('game-over-screen');
        const settingsModal = document.getElementById('settings-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalPeakWpmDisplay = document.getElementById('final-peak-wpm');
        const finalAccuracyDisplay = document.getElementById('final-accuracy');
        const customWordsInput = document.getElementById('custom-words-input');
        const customListNameInput = document.getElementById('custom-list-name');
        const categoryOptions = document.getElementById('category-options');
        const savedListsContainer = document.getElementById('saved-lists-container');
        const dbStatusDot = document.getElementById('db-status-dot');
        const dbStatusText = document.getElementById('db-status-text');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userProfileDiv = document.getElementById('user-profile');
        const userNameSpan = document.getElementById('user-name');
        const userPhotoImg = document.getElementById('user-photo');

        // --- Firebase 설정 ---
        let db, auth, userId, unsubscribeLists;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'typing-game-default';
        
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase 초기화 실패. 일부 기능이 작동하지 않을 수 있습니다.", e);
            updateDbStatus('error', '연결 실패');
        }

        // --- 단어 데이터 ---
        const baseWordData = {
            '초등 공통': [ { en: "apple", kr: "사과" }, { en: "banana", kr: "바나나" }, { en: "cat", kr: "고양이" }, { en: "dog", kr: "개" }, { en: "book", kr: "책" }, { en: "desk", kr: "책상" }, { en: "chair", kr: "의자" }, { en: "red", kr: "빨간색" } ],
            '초3': [ { en: "ant", kr: "개미" }, { en: "bed", kr: "침대" }, { en: "cup", kr: "컵" }, { en: "egg", kr: "달걀" }, { en: "fat", kr: "뚱뚱한" }, { en: "good", kr: "좋은" }, { en: "hot", kr: "더운" }, { en: "ink", kr: "잉크" } ],
            '초4': [ { en: "ball", kr: "공" }, { en: "cold", kr: "추운" }, { en: "door", kr: "문" }, { en: "face", kr: "얼굴" }, { en: "game", kr: "게임" }, { en: "hand", kr: "손" }, { en: "jump", kr: "뛰다" }, { en: "kind", kr: "친절한" } ],
            '초5': [ { en: "animal", kr: "동물" }, { en: "blue", kr: "파란색" }, { en: "class", kr: "수업" }, { en: "drink", kr: "마시다" }, { en: "english", kr: "영어" }, { en: "family", kr: "가족" }, { en: "great", kr: "훌륭한" }, { en: "happy", kr: "행복한" } ],
            '초6': [ { en: "always", kr: "항상" }, { en: "because", kr: "왜냐하면" }, { en: "country", kr: "나라" }, { en: "different", kr: "다른" }, { en: "enjoy", kr: "즐기다" }, { en: "favorite", kr: "가장 좋아하는" }, { en: "group", kr: "그룹" }, { en: "hobby", kr: "취미" } ]
        };
        let wordData = { ...baseWordData };

        // --- 게임 상태 및 설정 ---
        let score = 0, time = 0, typedIndex = 0;
        let totalTypedChars = 0, totalCorrectChars = 0, peakWpm = 0;
        let wordsQueue = [], currentWord = {};
        let gameInterval, isGameActive = false;
        let timeLimit = 0;
        let currentCategory = '초등 공통';
        let firstKeyPressTime = 0;
        let audioCtx;

        // --- 이벤트 리스너 ---
        document.addEventListener('DOMContentLoaded', initialize);
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);
        settingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        startGameBtn.addEventListener('click', applySettingsAndStart);
        saveListBtn.addEventListener('click', saveCurrentList);
        typingArea.addEventListener('click', () => typingArea.focus());
        document.addEventListener('keydown', handleKeyPress);
        speakBtn.addEventListener('click', () => {
            if (currentWord.en && isGameActive) speak(currentWord.en);
        });
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOutUser);

        // --- 함수 ---
        function isModalVisible() {
            return !startModal.classList.contains('hidden') || 
                   !gameOverScreen.classList.contains('hidden') || 
                   !settingsModal.classList.contains('hidden');
        }

        function initialize() {
            renderCategoryOptions();
            window.addEventListener('click', () => {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }, { once: true });

            if(auth) {
                onAuthStateChanged(auth, user => {
                    if (user && !user.isAnonymous) {
                        // 정식 로그인 사용자
                        userId = user.uid;
                        userNameSpan.textContent = user.displayName;
                        userPhotoImg.src = user.photoURL;
                        userProfileDiv.classList.remove('hidden');
                        userProfileDiv.classList.add('flex');
                        loginBtn.classList.add('hidden');
                        updateDbStatus('connected', '로그인 됨');
                        listenForCustomWordLists();
                    } else {
                        // 로그아웃 상태
                        userId = null;
                        userProfileDiv.classList.add('hidden');
                        userProfileDiv.classList.remove('flex');
                        loginBtn.classList.remove('hidden');
                        updateDbStatus('error', '로그인 필요');
                        if (unsubscribeLists) unsubscribeLists();
                        wordData = { ...baseWordData };
                        displaySavedLists([]);
                        renderCategoryOptions();
                    }
                });
            }
        }
        
        async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged가 나머지 UI 업데이트를 처리합니다.
            } catch (error) {
                console.error("Google 로그인 실패:", error);
                alert("Google 로그인에 실패했습니다. 팝업 차단을 해제했는지 확인해주세요.");
            }
        }

        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                 // onAuthStateChanged가 나머지 UI 업데이트를 처리합니다.
            } catch (error) {
                console.error("로그아웃 실패:", error);
            }
        }

        function renderCategoryOptions() {
            categoryOptions.innerHTML = '';
            const allCategories = Object.keys(wordData);
            allCategories.forEach(category => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-2 p-2 border rounded-md cursor-pointer";
                const input = document.createElement('input');
                input.type = 'radio'; input.name = 'category'; input.value = category;
                if (category === currentCategory) input.checked = true;
                label.appendChild(input);
                label.append(category);
                categoryOptions.appendChild(label);
            });
        }

        function updateDbStatus(status, text) {
            dbStatusText.textContent = text;
            if (status === 'connected') dbStatusDot.style.backgroundColor = '#22c55e'; // green-500
            else if (status === 'saving') dbStatusDot.style.backgroundColor = '#f59e0b'; // amber-500
            else dbStatusDot.style.backgroundColor = '#ef4444'; // red-500
        }

        function listenForCustomWordLists() {
            if (!userId) return;
            const listsCollectionRef = collection(db, "artifacts", appId, "users", userId, "customWordLists");
            
            if (unsubscribeLists) unsubscribeLists();

            unsubscribeLists = onSnapshot(listsCollectionRef, (querySnapshot) => {
                const customLists = {};
                querySnapshot.forEach((doc) => {
                    customLists[doc.id] = doc.data().words || [];
                });
                wordData = { ...baseWordData, ...customLists };
                displaySavedLists(Object.keys(customLists));
                renderCategoryOptions();
            }, (error) => {
                console.error("단어장 목록 실시간 업데이트 실패:", error);
                savedListsContainer.innerHTML = '<p class="text-red-500">목록을 불러오지 못했습니다.</p>';
            });
        }

        function displaySavedLists(listNames) {
            savedListsContainer.innerHTML = '';
            if (listNames.length === 0) {
                savedListsContainer.innerHTML = '<p class="text-slate-400">저장된 단어장이 없습니다.</p>';
                return;
            }
            listNames.forEach(listId => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 hover:bg-slate-200 rounded-md';
                div.innerHTML = `
                    <span class="truncate pr-2">${listId}</span>
                    <div class="flex gap-2 flex-shrink-0">
                        <button data-list-id="${listId}" class="load-btn text-xs bg-green-500 text-white px-2 py-1 rounded">불러오기</button>
                        <button data-list-id="${listId}" class="delete-btn text-xs bg-red-500 text-white px-2 py-1 rounded">삭제</button>
                    </div>
                `;
                savedListsContainer.appendChild(div);
            });

            document.querySelectorAll('.load-btn').forEach(btn => btn.addEventListener('click', (e) => loadListToEditor(e.target.dataset.listId)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteList(e.target.dataset.listId)));
        }
        
        function loadListToEditor(listId) {
            const words = wordData[listId] || [];
            customListNameInput.value = listId;
            customWordsInput.value = words.map(w => `${w.en},${w.kr}`).join('\n');
            const radioToSelect = document.querySelector(`input[name="category"][value="${listId}"]`);
            if (radioToSelect) radioToSelect.checked = true;
        }

        async function deleteList(listId) {
            if (!userId || !confirm(`'${listId}' 단어장을 정말 삭제하시겠습니까?`)) return;
            const docRef = doc(db, "artifacts", appId, "users", userId, "customWordLists", listId);
            try {
                await deleteDoc(docRef);
            } catch (error) {
                console.error("단어장 삭제 실패:", error);
            }
        }

        async function saveCurrentList() {
            if (!userId) {
                alert("단어장을 저장하려면 먼저 로그인해주세요.");
                return;
            }
            const listName = customListNameInput.value.trim();
            if (!listName) {
                alert("단어장 이름을 입력해주세요.");
                return;
            }
            if (baseWordData[listName]) {
                alert("기본 단어장과 동일한 이름으로는 저장할 수 없습니다.");
                return;
            }
            
            const customWordsText = customWordsInput.value.trim();
            const parsedWords = customWordsText.split('\n').map(line => {
                const parts = line.split(',');
                if (parts.length === 2 && parts[0].trim() && parts[1].trim()) {
                    return { en: parts[0].trim(), kr: parts[1].trim() };
                }
                return null;
            }).filter(Boolean);

            if (parsedWords.length === 0) {
                alert("저장할 단어가 없거나 형식이 올바르지 않습니다.");
                return;
            }

            updateDbStatus('saving', '저장중...');
            const docRef = doc(db, "artifacts", appId, "users", userId, "customWordLists", listName);
            try {
                await setDoc(docRef, { words: parsedWords });
                updateDbStatus('connected', '로그인 됨');
            } catch (error) {
                console.error("단어장 저장 실패:", error);
                updateDbStatus('error', '저장 실패');
            }
        }

        function applySettingsAndStart() {
            timeLimit = parseInt(document.querySelector('input[name="time"]:checked').value, 10);
            const selectedCategoryRadio = document.querySelector('input[name="category"]:checked');
            
            if (!selectedCategoryRadio) {
                alert("학습할 단어 목록을 선택해주세요.");
                return;
            }
            currentCategory = selectedCategoryRadio.value;
            
            closeSettings();
            startGame();
        }

        function playErrorSound() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.2);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                console.error('Browser does not support speech synthesis.');
                speakBtn.style.display = 'none';
            }
        }

        function openSettings() {
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        }

        function startGame() {
            score = 0; time = 0; typedIndex = 0;
            totalTypedChars = 0; totalCorrectChars = 0; peakWpm = 0;
            isGameActive = true;
            
            updateDisplays();
            accuracyDisplay.textContent = 100;
            wpmDisplay.textContent = 0;
            peakWpmDisplay.textContent = 0;
            
            wordsQueue = [...(wordData[currentCategory] || wordData['초등 공통'])].sort(() => 0.5 - Math.random());
            if (wordsQueue.length === 0) {
                alert('선택된 단어 목록이 비어있습니다. 설정에서 단어를 추가해주세요.');
                openSettings(); return;
            }

            startModal.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            settingsModal.classList.add('hidden');
            typingArea.focus();

            clearInterval(gameInterval);
            gameInterval = setInterval(gameTick, 1000);
        }

        function gameTick() {
            if (!isGameActive) return;
            time++;
            updateDisplays();
            if (timeLimit > 0 && time >= timeLimit) endGame();
        }

        function loadNextWord() {
            if (wordsQueue.length === 0) {
                endGame(); return;
            }
            currentWord = wordsQueue.shift();
            typedIndex = 0;
            firstKeyPressTime = 0;
            
            typingArea.innerHTML = '';
            currentWord.en.split('').forEach((char, index) => {
                const charSpan = document.createElement('span');
                charSpan.textContent = char;
                charSpan.className = index === 0 ? 'char char-active' : 'char char-placeholder';
                typingArea.appendChild(charSpan);
            });

            wordMeaningDisplay.textContent = currentWord.kr;
            upcomingWordsDisplay.textContent = wordsQueue.slice(0, 2).map(w => w.en).join(' ');
            
            speak(currentWord.en);
        }

        function handleKeyPress(e) {
            if (isModalVisible() || !isGameActive || e.key.length > 1 && e.key !== 'Backspace') return;
            e.preventDefault();

            const charSpans = typingArea.querySelectorAll('.char');
            
            if (e.key === 'Backspace') {
                if (typedIndex > 0) {
                    typedIndex--;
                    charSpans[typedIndex].className = 'char char-active';
                    charSpans[typedIndex + 1].className = 'char char-placeholder';
                }
                return;
            }
            
            if (typedIndex >= currentWord.en.length) return;

            const expectedChar = currentWord.en[typedIndex];
            const typedChar = e.key;
            
            totalTypedChars++;

            if (typedChar === expectedChar) {
                if (typedIndex === 0) {
                    firstKeyPressTime = performance.now();
                }

                totalCorrectChars++;
                charSpans[typedIndex].className = 'char char-correct';
                typedIndex++;

                if (typedIndex < currentWord.en.length) {
                    charSpans[typedIndex].className = 'char char-active';
                } else {
                    const elapsedTime = performance.now() - firstKeyPressTime;
                    const currentWordCpm = Math.round(currentWord.en.length / (elapsedTime / 60000));
                    
                    wpmDisplay.textContent = currentWordCpm;
                    if (currentWordCpm > peakWpm) {
                        peakWpm = currentWordCpm;
                        peakWpmDisplay.textContent = peakWpm;
                    }
                    
                    score += currentWord.en.length;
                    updateDisplays();
                    setTimeout(loadNextWord, 300);
                }
            } else {
                playErrorSound();
                charSpans[typedIndex].classList.add('char-incorrect', 'shake');
                setTimeout(() => {
                    charSpans[typedIndex].classList.remove('char-incorrect', 'shake');
                }, 400);
            }
            
            const accuracy = totalTypedChars === 0 ? 100 : Math.round((totalCorrectChars / totalTypedChars) * 100);
            accuracyDisplay.textContent = accuracy;
        }

        function updateDisplays() {
            scoreDisplay.textContent = score;
            timerDisplay.textContent = time;
        }

        function endGame() {
            isGameActive = false;
            clearInterval(gameInterval);
            window.speechSynthesis.cancel();

            const finalAccuracy = totalTypedChars === 0 ? 100 : Math.round((totalCorrectChars / totalTypedChars) * 100);

            finalScoreDisplay.textContent = score;
            finalPeakWpmDisplay.textContent = peakWpm;
            finalAccuracyDisplay.textContent = finalAccuracy;

            gameOverScreen.classList.remove('hidden');
            gameOverScreen.classList.add('flex');
        }
    </script>
</body>
</html>
